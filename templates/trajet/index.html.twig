{% extends 'base.html.twig' %}

{% block javascripts %}
<script>

    var users = [];

    $(document).ready(function(){

        function etoile(number){
            $('.etoile_' + number).hover(function () {
                    id = $(this).parent().attr('id');
                    setEtoile(number, id);
                }, 
                function () {
                    id = $(this).parent().attr('id');
                    if(id in users)
                        setEtoile(users[id], id);
                    else
                        setEtoile(0, id);
                }
            );

            $('.etoile_' + number).click(function () {
                id = $(this).parent().attr('id');
                $.ajax({
                    url: '{{ path('noteUtilisateur') }}', 
                    data: JSON.stringify({idEvaluateur: "{{ utilisateurActuel.id }}",
                                            idEvalue: id, 
                                            idTrajet: "{{ trajet.id }}",
                                            note: $(this).attr('class')[7]
                                            }),
                    method: 'POST',
                    contentType: 'application/json',
                    headers: {'X-Requested-With': 'XMLHttpRequest'},
                    success: function (response) 
                    {    
                        console.log(response);
                        users[id] = number;
                        setEtoile(number, id);
                    },
                    500: function(response) {
                        console.log(response.responseText)
                    },
                    501: function(response) {
                        console.log(response.responseText)
                    },
                    400: function(response) {
                        console.log(response.responseText)
                    }    
                });
            });
        }


        function setEtoile(number, id){
            $(document).find("#"+id).children().each(function() {
                if($(this).attr('class')[7] <= number)
                    $(this).attr('src','../etoile_pleine.png');
                else
                    $(this).attr('src','../etoile_vide.png');
            });
        }

        // Affichage des étoiles existantes
        {% for n in utilisateurActuel.notes %}
            {% if n.idTrajet.id == trajet.id %}
                users[{{n.idEvalue.id}}] = {{n.note}};
                setEtoile({{n.note}}, {{n.idEvalue.id}})
            {% endif %}
        {% endfor %}

        // Mise en place des event des étoiles de chaque utilisateur
        for(i = 1; i < 6; i++)
            etoile(i);
        
    });

</script>



{% endblock %}

{% block body %}
<style>
    .example-wrapper { margin: 1em auto; max-width: 800px; width: 95%; font: 18px/1.5 sans-serif; }
    .example-wrapper code { background: #F5F5F5; padding: 2px 6px; }
</style>

<div class="example-wrapper">
    <h1> Détails du trajet </h1>

    <p id="{{trajet.Covoitureur.id}}">Covoitureur : {{ include('_utilisateur_trajet_element.html.twig', {date: date, today: today, utilisateur: trajet.Covoitureur, utilisateurActuel: utilisateurActuel}) }}</p>

    <p id="lieuDepart">Lieu de départ : {{ lieuDepart }}</p>

    <p id="dateDepart">Date de départ : {{ date }}</p>

    <p id="lieuRDV">Lieu de rendez-vous : {{ trajet.precisionLieuRdv }}</p>

    <p id="prix">Prix : {{ trajet.prix }}€</p>

    <p {{ hidden }} id="prevPointsIntermediaires">Etape(s) intermédiaire(s) : </p>
    
    
        <div id="listePtIntermediaires">
            <ol>
                {{ listePointsIntermediaires|raw }}
            </ol>
        </div>
    
    

    <p id="lieuArrive">Lieu d'arrivé : {{ lieuArrive }} </p>

    <p id="commentaire">Commentaire du covoitureur : {{ trajet.commentaire }} </p>

    <p id="capaciteMax">Places occupées : {{trajet.utilisateurs|length}}/{{ trajet.capaciteMax }}</p>

    <h2>Participants</h2>
    <div id="listeParticipants">
        <ul>
            {% for u in trajet.utilisateurs %}
                {% if u.id != trajet.Covoitureur.id %}
                    <li id='{{ u.id }}'>
                        {{ include('_utilisateur_trajet_element.html.twig', {date: date, today: today, utilisateur: u, utilisateurActuel: utilisateurActuel}) }}
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>

</div>
{% endblock %}
